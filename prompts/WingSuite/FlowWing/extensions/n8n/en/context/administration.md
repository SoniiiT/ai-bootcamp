# Administration & Security Guide

This comprehensive guide covers the administration, security hardening, user management, and maintenance of self-hosted n8n instances. It is designed for DevOps engineers and System Administrators.

## User Management

n8n provides a role-based access control (RBAC) system to manage user permissions and collaboration.

### User Roles & Permissions

| Role | Scope | Capabilities | Limitations |
| :--- | :--- | :--- | :--- |
| **Instance Owner** | Global | Full access to all workflows, credentials, and instance settings. Can manage all users. | Cannot be deleted (only transferred). |
| **Instance Admin** | Global | Can manage users, instance settings, and view all workflows. | Cannot delete or demote the Instance Owner. |
| **Member** | Global | Can create workflows and credentials. Can share workflows with others. | Cannot access instance settings or manage other users. |

### User Provisioning

#### 1. CLI Management
You can manage users directly via the CLI if you have shell access to the n8n container.

```bash
# List all users
n8n user-management:user:list

# Create a new user
n8n user-management:user:create --email="user@example.com" --firstName="John" --lastName="Doe" --role="global:member"

# Reset a user's password
n8n user-management:user:reset-password --email="user@example.com" --password="newsecurepassword"

# Change a user's role
n8n user-management:user:update --email="user@example.com" --role="global:admin"
```

#### 2. Email Invitations (SMTP)
To enable UI-based invitations, you must configure SMTP environment variables.

```bash
# .env configuration
N8N_EMAIL_MODE=smtp
N8N_SMTP_HOST=smtp.sendgrid.net
N8N_SMTP_PORT=587
N8N_SMTP_USER=apikey
N8N_SMTP_PASS=SG.xxxx
N8N_SMTP_SENDER=n8n@yourdomain.com
N8N_SMTP_SSL=false
```

#### 3. SSO (Enterprise)
Enterprise plans support SAML and OIDC for Single Sign-On.
*   **SAML**: Supports Okta, Google Workspace, JumpCloud, etc.
*   **OIDC**: Supports Auth0, Azure AD, Keycloak.
*   **Just-in-Time (JIT) Provisioning**: Users are created automatically upon first login.

---

## Security Hardening

Securing your n8n instance is critical, especially if it is exposed to the public internet.

### Authentication & Access Control

#### Basic Auth (Global)
If you are not using the user management system (e.g., single-user mode), protect the entire instance with Basic Auth.
*   `N8N_BASIC_AUTH_ACTIVE=true`
*   `N8N_BASIC_AUTH_USER=admin`
*   `N8N_BASIC_AUTH_PASSWORD=securepassword`

#### Endpoint Protection
By default, n8n exposes webhook endpoints. You can restrict access to the UI and API.

*   **`N8N_ENDPOINT_RESTRICTIONS_ENABLED=true`**: Enables restriction logic.
*   **`N8N_AUTH_EXCLUDE_ENDPOINTS`**: List of endpoints to exclude from authentication (e.g., `/healthz`).

### External Secrets (Vaults)
Never store sensitive API keys or database passwords directly in the n8n database if possible. Use an External Secrets provider.

#### Supported Providers
*   AWS Secrets Manager
*   Azure Key Vault
*   Google Cloud Secret Manager
*   HashiCorp Vault
*   Infisical

#### Configuration Steps
1.  **Connect Provider**: Go to **Settings > External Secrets** and add your provider credentials.
2.  **Reference Secrets**: In any node credential field, switch the input mode to **Expression**.
3.  **Syntax**:
    ```javascript
    // Syntax: {{ $secrets.<provider>.<secret_name> }}
    
    // AWS Secrets Manager (JSON object)
    {{ $secrets.awsSecretsManager.myApiKey }}
    
    // HashiCorp Vault (KV engine)
    {{ $secrets.vault.database_password }}
    
    // Infisical
    {{ $secrets.infisical.stripe_live_key }}
    ```

#### Pro Tips
*   **Caching**: n8n caches secrets to reduce API calls to the vault. Configure `N8N_EXTERNAL_SECRETS_CACHE_TTL` (default: 300 seconds) to balance security and performance.
*   **Environment Variables**: You can also use `{{ $env.MY_VAR }}` to access environment variables injected into the container, which is a simpler alternative to a full vault for static secrets.

### Network Security
*   **Reverse Proxy**: Always run n8n behind a reverse proxy (Nginx, Traefik, Caddy) handling SSL/TLS termination.
*   **Webhook Tunnel**: For local development, use the `--tunnel` flag. For production, ensure `WEBHOOK_URL` is set to your public HTTPS domain.
*   **CSP Headers**: n8n sets strict Content Security Policy headers. If you embed n8n in an iframe, you must configure `N8N_EDITOR_BASE_URL` and potentially adjust CSP settings via environment variables (use with caution).

---

## Logging & Auditing

### Application Logs
Standard logs generated by the n8n process (Node.js).
*   **Format**: JSON or Text (`N8N_LOG_OUTPUT=json`).
*   **Level**: `N8N_LOG_LEVEL` (debug, info, warn, error).
*   **Destination**: stdout/stderr (standard Docker logging).

### Log Streaming (Events)
n8n can stream execution events to external monitoring tools. This is distinct from application logs.

#### Destinations
*   **Syslog**: Standard protocol for log aggregation.
*   **PostHog**: Product analytics.
*   **Sentry**: Error tracking.
*   **Webhook**: Generic HTTP POST to any endpoint (e.g., Splunk, Datadog, Slack).

#### Configurable Events
| Event Name | Description |
| :--- | :--- |
| `workflow.started` | Triggered when an execution begins. |
| `workflow.finished` | Triggered when an execution completes successfully. |
| `workflow.failed` | Triggered when an execution errors out. |
| `node.started` | Triggered when a specific node starts processing. |
| `node.finished` | Triggered when a node finishes. |
| `node.failed` | Triggered when a node errors. |
| `audit.user.login` | User login events. |
| `audit.workflow.created` | Workflow creation events. |

#### Webhook Payload Example
```json
{
  "eventName": "workflow.failed",
  "workflowId": "123",
  "executionId": "456",
  "error": {
    "message": "API Rate Limit Exceeded",
    "node": "HTTP Request"
  },
  "timestamp": "2023-10-27T10:00:00Z"
}
```

### Audit Logs (Enterprise)
Enterprise plans include a detailed Audit Log view in the UI.
*   **Tracks**: Who did what and when.
*   **Scope**: User logins, credential access, workflow modifications, execution retries.
*   **Retention**: Configurable retention period.

---

## Maintenance & Operations

### Database Management
n8n uses a database (SQLite, Postgres, MySQL) to store workflows, credentials, and execution history.

#### Pruning Execution Data
Execution data grows rapidly. You **must** configure pruning to prevent disk overflow.

```bash
# Enable pruning
EXECUTIONS_DATA_PRUNE=true

# Max age of executions to keep (in hours)
EXECUTIONS_DATA_MAX_AGE=168  # 7 days

# Max count of executions to keep (per workflow)
EXECUTIONS_DATA_PRUNE_MAX_COUNT=10000
```

#### Database Migration
*   **SQLite**: Default. Good for testing/low load. Not recommended for production.
*   **PostgreSQL**: Recommended for production.
    *   Set `DB_TYPE=postgresdb`.
    *   Set `DB_POSTGRESDB_HOST`, `DB_POSTGRESDB_PORT`, `DB_POSTGRESDB_DATABASE`, `DB_POSTGRESDB_USER`, `DB_POSTGRESDB_PASSWORD`.

### Updates & Upgrades
*   **Docker Tagging**: Avoid using `latest`. Pin to a specific version (e.g., `n8n/n8n:1.15.0`) to prevent unexpected breaking changes.
*   **Backup**: Always backup your database and the `.n8n` directory (encryption key) before upgrading.
*   **Rollback**: If an upgrade fails, revert the Docker image tag and restore the database backup.

### Public API
n8n exposes a Public API to manage the instance programmatically.
*   **Documentation**: `http://<your-instance>/api/v1/docs`
*   **Authentication**: Requires an API Key (generate in **Settings > API**).
*   **Capabilities**:
    *   Export/Import workflows.
    *   Manage credentials.
    *   Trigger workflows.
    *   Get execution status.

```javascript
// Example: Trigger workflow via Public API
const response = await fetch('https://n8n.example.com/api/v1/executions', {
  method: 'POST',
  headers: {
    'X-N8N-API-KEY': 'your-api-key'
  },
  body: JSON.stringify({
    workflowId: '123'
  })
});
```

## Troubleshooting Common Admin Issues

### "Workflow is locked"
*   **Cause**: Another user is editing the workflow, or a browser session didn't close properly.
*   **Fix**: Ask the user to close the tab, or wait for the lock to timeout. As an admin, you can force take over (Enterprise).

### "Execution data is missing"
*   **Cause**: Pruning settings deleted the data, or `EXECUTIONS_DATA_SAVE_ON_SUCCESS=false`.
*   **Fix**: Check `EXECUTIONS_DATA_SAVE_ON_SUCCESS` (default is `true`). For high-volume instances, set this to `false` and only save errors (`EXECUTIONS_DATA_SAVE_ON_ERROR=true`).

### "n8n keeps restarting"
*   **Cause**: OOM (Out of Memory).
*   **Fix**:
    1.  Check Docker memory limits.
    2.  Reduce `EXECUTIONS_PROCESS=main` concurrency.
    3.  Switch to `EXECUTIONS_MODE=queue` (Worker mode) to distribute load.
